'use strict';

var _Object$create = require('babel-runtime/core-js/object/create')['default'];

var _Object$keys = require('babel-runtime/core-js/object/keys')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
    value: true
});

var _q = require('q');

var _q2 = _interopRequireDefault(_q);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _deepmerge = require('deepmerge');

var _deepmerge2 = _interopRequireDefault(_deepmerge);

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _utilsRequestHandler = require('./utils/RequestHandler');

var _utilsRequestHandler2 = _interopRequireDefault(_utilsRequestHandler);

var _utilsErrorHandler = require('./utils/ErrorHandler');

var _utilsLogger = require('./utils/Logger');

var _utilsLogger2 = _interopRequireDefault(_utilsLogger);

var _helpersSafeExecute = require('./helpers/safeExecute');

var _helpersSafeExecute2 = _interopRequireDefault(_helpersSafeExecute);

var _helpersSanitize = require('./helpers/sanitize');

var _helpersSanitize2 = _interopRequireDefault(_helpersSanitize);

var _helpersIsMobile = require('./helpers/isMobile');

var _helpersIsMobile2 = _interopRequireDefault(_helpersIsMobile);

var _helpersDetectSeleniumBackend = require('./helpers/detectSeleniumBackend');

var _helpersDetectSeleniumBackend2 = _interopRequireDefault(_helpersDetectSeleniumBackend);

var INTERNAL_EVENTS = ['init', 'command', 'error', 'result', 'end'];
var PROMISE_FUNCTIONS = ['then', 'catch', 'finally'];

var EventEmitter = _events2['default'].EventEmitter;

/**
 * WebdriverIO v4
 */
var WebdriverIO = function WebdriverIO(args, modifier) {
    var prototype = _Object$create(Object.prototype);
    var eventHandler = new EventEmitter();
    var fulFilledPromise = (0, _q2['default'])();
    var stacktrace = [];
    var commandList = [];

    var EVENTHANDLER_FUNCIONS = Object.getPrototypeOf(eventHandler);

    /**
     * merge default options with given user options
     */
    var options = (0, _deepmerge2['default'])({
        protocol: 'http',
        waitforTimeout: 500,
        coloredLogs: true,
        logLevel: 'silent',
        baseUrl: null
    }, typeof args !== 'string' ? args : {});

    /**
     * define Selenium backend given on user options
     */
    options = (0, _deepmerge2['default'])((0, _helpersDetectSeleniumBackend2['default'])(args), options);

    /**
     * only set globals we wouldn't get otherwise
     */
    if (!process.env.WEBDRIVERIO_COLORED_LOGS) {
        process.env.WEBDRIVERIO_COLORED_LOGS = options.coloredLogs;
    }

    var logger = new _utilsLogger2['default'](options, eventHandler);
    var requestHandler = new _utilsRequestHandler2['default'](options, eventHandler, logger);

    /**
     * assign instance to existing session
     */
    if (typeof args === 'string') {
        requestHandler.sessionID = args;
    }

    var desiredCapabilities = (0, _deepmerge2['default'])({
        browserName: 'firefox',
        version: '',
        javascriptEnabled: true,
        locationContextEnabled: true,
        handlesAlerts: true,
        rotatable: true,
        platform: 'ANY'
    }, options.desiredCapabilities || {});

    /**
     * set default logging prefs to enable log commands (mainly for chromedriver)
     */
    if (typeof desiredCapabilities.loggingPrefs === 'undefined') {
        desiredCapabilities.loggingPrefs = {
            browser: 'ALL',
            driver: 'ALL'
        };
    }

    var isMobile = (0, _helpersIsMobile2['default'])(desiredCapabilities);

    var resolve = function resolve(result, isErrorHandled) {
        if (typeof result === 'function') {
            this.isExecuted = true;
            result = result.call(this);
        }

        var resolveMethod = result instanceof Error ? 'reject' : 'resolve';
        this.defer[resolveMethod](result);

        /**
         * By using finally in our next method we omit the duty to throw an exception an some
         * point. To avoid propagating rejected promises until everything crashes silently we
         * check if the last and current promise got rejected. If so we can throw the error.
         */
        if (this.promise.isRejected() && !isErrorHandled) {
            /**
             * take screenshot only if screenshotPath is given
             */
            if (typeof options.screenshotPath !== 'string') {
                return throwException(result, stacktrace);
            }

            var screenshotPath = _path2['default'].join(process.cwd(), options.screenshotPath);

            /**
             * take screenshot only if directory exists
             */
            if (!_fs2['default'].existsSync(screenshotPath)) {
                return throwException(result, stacktrace);
            }

            var client = unit();
            client.next(prototype.saveScreenshot, [_path2['default'].join(screenshotPath, 'ERROR_' + _helpersSanitize2['default'].caps(desiredCapabilities) + '_' + new Date().toJSON() + '.png')], 'saveScreenshot');

            var stack = stacktrace.slice();
            return throwException.bind(null, result, stack);
        }

        return this.promise;
    };

    function throwException(e, stack) {
        stack = stack.slice(0, -1).map(function (trace) {
            return '    at ' + trace;
        });
        e.stack = e.type + ': ' + e.message + '\n' + stack.reverse().join('\n');
        throw e;
    }

    /**
     * WebdriverIO Monad
     */
    function unit(lastPromise) {
        var client = _Object$create(prototype);
        var defer = _q2['default'].defer();
        var promise = defer.promise;

        client.defer = defer;
        client.promise = promise;
        client.lastPromise = lastPromise || fulFilledPromise;

        client.desiredCapabilities = desiredCapabilities;
        client.requestHandler = requestHandler;
        client.logger = logger;
        client.options = options;
        client.isMobile = isMobile;
        client.commandList = commandList;

        /**
         * actual bind function
         */
        client.next = function (func, args, name) {
            var _this = this;

            /**
             * use finally to propagate rejected promises up the chain
             */
            return this.lastPromise.then(function () {
                /**
                 * store command into command list so `getHistory` can return it
                 */
                commandList.push({
                    name: name,
                    args: args
                });

                return resolve.call(_this, (0, _helpersSafeExecute2['default'])(func, args));
            }, function (e) {
                /**
                 * reject pending commands in chain
                 */
                if (e.isPropagatedError) {
                    return _this.defer.reject(e);
                }

                _this.emit('error', {
                    message: e.message,
                    type: e.type,
                    stack: stacktrace
                });

                /**
                 * mark error as propagated so that error messages get only printed once
                 */
                e.isPropagatedError = true;
                logger.printException(e.type || 'Error', e.message, stacktrace);
                _this.defer.reject(e);
            });
        };

        client['finally'] = function (fn) {
            var _this2 = this;

            var client = unit(this.promise['finally'](function () {
                return resolve.call(client, (0, _helpersSafeExecute2['default'])(fn, []).bind(_this2));
            }));
            return client;
        };

        client.call = function (fn) {
            var _this3 = this;

            var client = unit(this.promise.done(function () {
                return resolve.call(client, (0, _helpersSafeExecute2['default'])(fn, []).bind(_this3));
            }));
            return client;
        };

        client.then = function (onFulfilled, onRejected) {
            var _this4 = this;

            if (typeof onFulfilled !== 'function' && typeof onRejected !== 'function') {
                return this;
            }

            /**
             * execute then function in context of the new instance
             * but resolve result with this
             */
            var client = unit(this.promise.then(function () {
                for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {
                    args[_key] = arguments[_key];
                }

                return resolve.call(client, (0, _helpersSafeExecute2['default'])(onFulfilled, args).bind(_this4));
            }, function () {
                for (var _len2 = arguments.length, args = Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
                    args[_key2] = arguments[_key2];
                }

                return resolve.call(client, (0, _helpersSafeExecute2['default'])(onRejected, args).bind(_this4), typeof onRejected === 'function');
            }));

            return client;
        };

        client['catch'] = function (onRejected) {
            return this.then(undefined, onRejected);
        };

        client.inspect = function () {
            return this.promise.inspect();
        };

        /**
         * internal helper method to handle command results
         *
         * @param  {Promise[]} promises  list of promises
         * @param  {Boolean}   option    if true extract value property from selenium result
         */
        client.unify = function (promises, option) {
            option = option || {};
            promises = Array.isArray(promises) ? promises : [promises];

            return _q2['default'].all(promises)
            /**
             * extract value property from result if desired
             */
            .then(function (result) {
                if (!option.extractValue || !Array.isArray(result)) {
                    return result;
                }

                return result.map(function (res) {
                    return res.value && typeof res.value === 'string' ? res.value.trim() : res.value;
                });

                /**
                 * sanitize result for better assertion
                 */
            }).then(function (result) {
                if (Array.isArray(result) && result.length === 1) {
                    result = result[0];
                }

                if (option.lowercase && typeof result === 'string') {
                    result = result.toLowerCase();
                }

                return result;
            });
        };

        client.addCommand = function (fnName, fn, forceOverwrite) {
            if (typeof fn === 'string') {
                var namespace = arguments[0];
                fnName = arguments[1];
                fn = arguments[2];
                forceOverwrite = arguments[3];

                switch (typeof client[namespace]) {
                    case 'function':
                        throw new _utilsErrorHandler.RuntimeError('Command namespace "' + namespace + '" is used internally, and can\'t be overwritten!');
                    case 'object':
                        if (client[namespace][fnName] && !forceOverwrite) {
                            throw new _utilsErrorHandler.RuntimeError('Command "' + fnName + '" is already defined!');
                        }
                        break;
                }
                return unit.lift(namespace, fnName, fn);
            }

            if (client[fnName] && !forceOverwrite) {
                throw new _utilsErrorHandler.RuntimeError('Command "' + fnName + '" is already defined!');
            }
            return unit.lift(fnName, fn);
        };

        client.transferPromiseness = function (target, promise) {
            /**
             * transfer WebdriverIO commands
             */
            var clientFunctions = _Object$keys(prototype);
            var functionsToTranfer = clientFunctions.concat(PROMISE_FUNCTIONS);

            var _iteratorNormalCompletion = true;
            var _didIteratorError = false;
            var _iteratorError = undefined;

            try {
                for (var _iterator = _getIterator(functionsToTranfer), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                    var fnName = _step.value;

                    if (typeof promise[fnName] === 'function') {
                        target[fnName] = promise[fnName].bind(promise);
                    }
                }
            } catch (err) {
                _didIteratorError = true;
                _iteratorError = err;
            } finally {
                try {
                    if (!_iteratorNormalCompletion && _iterator['return']) {
                        _iterator['return']();
                    }
                } finally {
                    if (_didIteratorError) {
                        throw _iteratorError;
                    }
                }
            }
        };

        if (typeof modifier === 'function') {
            client = modifier(client, options);
        }

        return client;
    }

    /**
     * enhance base monad prototype with methods
     */
    unit.lift = function (name, func) {
        var commandGroup = prototype;

        if (typeof func === 'string') {
            var namespace = arguments[0];
            name = arguments[1];
            func = arguments[2];

            if (!prototype[namespace]) {
                prototype[namespace] = {};
            }

            commandGroup = prototype[namespace];
        }

        commandGroup[name] = function () {
            var nextPromise = this.promise;

            /**
             * commands executed inside commands don't have to wait
             * on any promise
             */
            if (this.isExecuted) {
                nextPromise = this.lastPromise;
            }

            var client = unit(nextPromise);

            /**
             * catch stack to find information about where the command that causes
             * the error was used (stack line 2) and only save it when it was not
             * within WebdriverIO context
             */
            var stack = new Error().stack;
            var lineInTest = stack.split('\n').slice(2, 3).join('\n');
            var fileAndPosition = lineInTest.slice(lineInTest.indexOf('(') + 1, lineInTest.indexOf(')'));
            var atCommand = lineInTest.trim().slice(3).split(' ')[0];

            atCommand = atCommand.slice(atCommand.lastIndexOf('.') + 1);

            for (var _len3 = arguments.length, args = Array(_len3), _key3 = 0; _key3 < _len3; _key3++) {
                args[_key3] = arguments[_key3];
            }

            var trace = name + '(' + _helpersSanitize2['default'].args(args) + ') - ' + fileAndPosition.slice(fileAndPosition.lastIndexOf('/') + 1);
            if (_Object$keys(prototype).indexOf(atCommand) === -1 && atCommand !== 'exports') {
                stacktrace = [trace];
            } else {
                /**
                 * save trace for nested commands
                 */
                stacktrace.push(trace);
            }

            /**
             * queue command
             */
            client.next(func, args, name);
            return client;
        };

        return unit;
    };

    /**
     * register event emitter
     */

    var _loop = function (eventCommand) {
        prototype[eventCommand] = function () {
            for (var _len4 = arguments.length, args = Array(_len4), _key4 = 0; _key4 < _len4; _key4++) {
                args[_key4] = arguments[_key4];
            }

            /**
             * custom commands needs to get emitted and registered in order
             * to prevent race conditions
             */
            if (INTERNAL_EVENTS.indexOf(args[0]) === -1) {
                return this['finally'](function () {
                    return eventHandler[eventCommand].apply(eventHandler, args);
                });
            }

            eventHandler[eventCommand].apply(eventHandler, args);
            return this;
        };
    };

    for (var eventCommand in EVENTHANDLER_FUNCIONS) {
        _loop(eventCommand);
    }

    return unit;
};

exports['default'] = WebdriverIO;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi93ZWJkcml2ZXJpby5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUE7Ozs7Ozs7Ozs7Ozs7O2lCQUVFLEdBQUc7Ozs7a0JBQ0YsSUFBSTs7OztvQkFDRixNQUFNOzs7O3lCQUNMLFdBQVc7Ozs7c0JBQ1YsUUFBUTs7OzttQ0FFQSx3QkFBd0I7Ozs7aUNBQ3RCLHNCQUFzQjs7MkJBQ2hDLGdCQUFnQjs7OztrQ0FFWCx1QkFBdUI7Ozs7K0JBQzFCLG9CQUFvQjs7OzsrQkFDZCxvQkFBb0I7Ozs7NENBQ2IsaUNBQWlDOzs7O0FBRW5FLElBQU0sZUFBZSxHQUFHLENBQUMsTUFBTSxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFBO0FBQ3JFLElBQU0saUJBQWlCLEdBQUcsQ0FBQyxNQUFNLEVBQUUsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFBOztBQUV0RCxJQUFJLFlBQVksR0FBRyxvQkFBTyxZQUFZLENBQUE7Ozs7O0FBS3RDLElBQUksV0FBVyxHQUFHLFNBQWQsV0FBVyxDQUFhLElBQUksRUFBRSxRQUFRLEVBQUU7QUFDeEMsUUFBSSxTQUFTLEdBQUcsZUFBYyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUE7QUFDL0MsUUFBSSxZQUFZLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQTtBQUNyQyxRQUFJLGdCQUFnQixHQUFHLHFCQUFHLENBQUE7QUFDMUIsUUFBSSxVQUFVLEdBQUcsRUFBRSxDQUFBO0FBQ25CLFFBQUksV0FBVyxHQUFHLEVBQUUsQ0FBQTs7QUFFcEIsUUFBTSxxQkFBcUIsR0FBRyxNQUFNLENBQUMsY0FBYyxDQUFDLFlBQVksQ0FBQyxDQUFBOzs7OztBQUtqRSxRQUFJLE9BQU8sR0FBRyw0QkFBTTtBQUNoQixnQkFBUSxFQUFFLE1BQU07QUFDaEIsc0JBQWMsRUFBRSxHQUFHO0FBQ25CLG1CQUFXLEVBQUUsSUFBSTtBQUNqQixnQkFBUSxFQUFFLFFBQVE7QUFDbEIs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Q0FBQTtBQUNuSCxnQkFBSSxhQUFZLFNBQVMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxTQUFTLEtBQUssU0FBUyxFQUFFO0FBQzdFLDBCQUFVLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQTthQUN2QixNQUFNOzs7O0FBSUgsMEJBQVUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUE7YUFDekI7Ozs7O0FBS0Qsa0JBQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQTtBQUM3QixtQkFBTyxNQUFNLENBQUE7U0FDaEIsQ0FBQTs7QUFFRCxlQUFPLElBQUksQ0FBQTtLQUNkLENBQUE7Ozs7OzswQkFLUSxZQUFZO0FBQ2pCLGlCQUFTLENBQUMsWUFBWSxDQUFDLEdBQUcsWUFBbUI7K0NBQU4sSUFBSTtBQUFKLG9CQUFJOzs7Ozs7O0FBS3ZDLGdCQUFJLGVBQWUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7QUFDekMsdUJBQU8sSUFBSSxXQUFRLENBQUM7MkJBQU0sWUFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDLEtBQUssQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDO2lCQUFBLENBQUMsQ0FBQTthQUNsRjs7QUFFRCx3QkFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDLEtBQUssQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLENBQUE7QUFDcEQsbUJBQU8sSUFBSSxDQUFBO1NBQ2QsQ0FBQTs7O0FBWkwsU0FBSyxJQUFJLFlBQVksSUFBSSxxQkFBcUIsRUFBRTtjQUF2QyxZQUFZO0tBYXBCOztBQUVELFdBQU8sSUFBSSxDQUFBO0NBQ2QsQ0FBQTs7cUJBRWMsV0FBVyIsImZpbGUiOiJ3ZWJkcml2ZXJpby5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0J1xuXG5pbXBvcnQgcSBmcm9tICdxJ1xuaW1wb3J0IGZzIGZyb20gJ2ZzJ1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCdcbmltcG9ydCBtZXJnZSBmcm9tICdkZWVwbWVyZ2UnXG5pbXBvcnQgZXZlbnRzIGZyb20gJ2V2ZW50cydcblxuaW1wb3J0IFJlcXVlc3RIYW5kbGVyIGZyb20gJy4vdXRpbHMvUmVxdWVzdEhhbmRsZXInXG5pbXBvcnQgeyBSdW50aW1lRXJyb3IgfSBmcm9tICcuL3V0aWxzL0Vycm9ySGFuZGxlcidcbmltcG9ydCBMb2dnZXIgZnJvbSAnLi91dGlscy9Mb2dnZXInXG5cbmltcG9ydCBzYWZlRXhlY3V0ZSBmcm9tICcuL2hlbHBlcnMvc2FmZUV4ZWN1dGUnXG5pbXBvcnQgc2FuaXRpemUgZnJvbSAnLi9oZWxwZXJzL3Nhbml0aXplJ1xuaW1wb3J0IGlzTW9iaWxlSGVscGVyIGZyb20gJy4vaGVscGVycy9pc01vYmlsZSdcbmltcG9ydCBkZXRlY3RTZWxlbml1bUJhY2tlbmQgZnJvbSAnLi9oZWxwZXJzL2RldGVjdFNlbGVuaXVtQmFja2VuZCdcblxuY29uc3QgSU5URVJOQUxfRVZFTlRTID0gWydpbml0JywgJ2NvbW1hbmQnLCAnZXJyb3InLCAncmVzdWx0JywgJ2VuZCddXG5jb25zdCBQUk9NSVNFX0ZVTkNUSU9OUyA9IFsndGhlbicsICdjYXRjaCcsICdmaW5hbGx5J11cblxubGV0IEV2ZW50RW1pdHRlciA9IGV2ZW50cy5FdmVudEVtaXR0ZXJcblxuLyoqXG4gKiBXZWJkcml2ZXJJTyB2NFxuICovXG5sZXQgV2ViZHJpdmVySU8gPSBmdW5jdGlvbiAoYXJncywgbW9kaWZpZXIpIHtcbiAgICBsZXQgcHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShPYmplY3QucHJvdG90eXBlKVxuICAgIGxldCBldmVudEhhbmRsZXIgPSBuZXcgRXZlbnRFbWl0dGVyKClcbiAgICBsZXQgZnVsRmlsbGVkUHJvbWlzZSA9IHEoKVxuICAgIGxldCBzdGFja3RyYWNlID0gW11cbiAgICBsZXQgY29tbWFuZExpc3QgPSBbXVxuXG4gICAgY29uc3QgRVZFTlRIQU5ETEVSX0ZVTkNJT05TID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKGV2ZW50SGFuZGxlcilcblxuICAgIC8qKlxuICAgICAqIG1lcmdlIGRlZmF1bHQgb3B0aW9ucyB3aXRoIGdpdmVuIHVzZXIgb3B0aW9uc1xuICAgICAqL1xuICAgIGxldCBvcHRpb25zID0gbWVyZ2Uoe1xuICAgICAgICBwcm90b2NvbDogJ2h0dHAnLFxuICAgICAgICB3YWl0Zm9yVGltZW91dDogNTAwLFxuICAgICAgICBjb2xvcmVkTG9nczogdHJ1ZSxcbiAgICAgICAgbG9nTGV2ZWw6ICdzaWxlbnQnLFxuICAgICAgICBiYXNlVXJsOiBudWxsXG4gICAgfSwgdHlwZW9mIGFyZ3MgIT09ICdzdHJpbmcnID8gYXJncyA6IHt9KVxuXG4gICAgLyoqXG4gICAgICogZGVmaW5lIFNlbGVuaXVtIGJhY2tlbmQgZ2l2ZW4gb24gdXNlciBvcHRpb25zXG4gICAgICovXG4gICAgb3B0aW9ucyA9IG1lcmdlKGRldGVjdFNlbGVuaXVtQmFja2VuZChhcmdzKSwgb3B0aW9ucylcblxuICAgIC8qKlxuICAgICAqIG9ubHkgc2V0IGdsb2JhbHMgd2Ugd291bGRuJ3QgZ2V0IG90aGVyd2lzZVxuICAgICAqL1xuICAgIGlmICghcHJvY2Vzcy5lbnYuV0VCRFJJVkVSSU9fQ09MT1JFRF9MT0dTKSB7XG4gICAgICAgIHByb2Nlc3MuZW52LldFQkRSSVZFUklPX0NPTE9SRURfTE9HUyA9IG9wdGlvbnMuY29sb3JlZExvZ3NcbiAgICB9XG5cbiAgICBsZXQgbG9nZ2VyID0gbmV3IExvZ2dlcihvcHRpb25zLCBldmVudEhhbmRsZXIpXG4gICAgbGV0IHJlcXVlc3RIYW5kbGVyID0gbmV3IFJlcXVlc3RIYW5kbGVyKG9wdGlvbnMsIGV2ZW50SGFuZGxlciwgbG9nZ2VyKVxuXG4gICAgLyoqXG4gICAgICogYXNzaWduIGluc3RhbmNlIHRvIGV4aXN0aW5nIHNlc3Npb25cbiAgICAgKi9cbiAgICBpZiAodHlwZW9mIGFyZ3MgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHJlcXVlc3RIYW5kbGVyLnNlc3Npb25JRCA9IGFyZ3NcbiAgICB9XG5cbiAgICBsZXQgZGVzaXJlZENhcGFiaWxpdGllcyA9IG1lcmdlKHtcbiAgICAgICAgYnJvd3Nlck5hbWU6ICdmaXJlZm94JyxcbiAgICAgICAgdmVyc2lvbjogJycsXG4gICAgICAgIGphdmFzY3JpcHRFbmFibGVkOiB0cnVlLFxuICAgICAgICBsb2NhdGlvbkNvbnRleHRFbmFibGVkOiB0cnVlLFxuICAgICAgICBoYW5kbGVzQWxlcnRzOiB0cnVlLFxuICAgICAgICByb3RhdGFibGU6IHRydWUsXG4gICAgICAgIHBsYXRmb3JtOiAnQU5ZJ1xuICAgIH0sIG9wdGlvbnMuZGVzaXJlZENhcGFiaWxpdGllcyB8fCB7fSlcblxuICAgIC8qKlxuICAgICAqIHNldCBkZWZhdWx0IGxvZ2dpbmcgcHJlZnMgdG8gZW5hYmxlIGxvZyBjb21tYW5kcyAobWFpbmx5IGZvciBjaHJvbWVkcml2ZXIpXG4gICAgICovXG4gICAgaWYgKHR5cGVvZiBkZXNpcmVkQ2FwYWJpbGl0aWVzLmxvZ2dpbmdQcmVmcyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgZGVzaXJlZENhcGFiaWxpdGllcy5sb2dnaW5nUHJlZnMgPSB7XG4gICAgICAgICAgICBicm93c2VyOiAnQUxMJyxcbiAgICAgICAgICAgIGRyaXZlcjogJ0FMTCdcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGxldCBpc01vYmlsZSA9IGlzTW9iaWxlSGVscGVyKGRlc2lyZWRDYXBhYmlsaXRpZXMpXG5cbiAgICBsZXQgcmVzb2x2ZSA9IGZ1bmN0aW9uIChyZXN1bHQsIGlzRXJyb3JIYW5kbGVkKSB7XG4gICAgICAgIGlmICh0eXBlb2YgcmVzdWx0ID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICB0aGlzLmlzRXhlY3V0ZWQgPSB0cnVlXG4gICAgICAgICAgICByZXN1bHQgPSByZXN1bHQuY2FsbCh0aGlzKVxuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHJlc29sdmVNZXRob2QgPSByZXN1bHQgaW5zdGFuY2VvZiBFcnJvciA/ICdyZWplY3QnIDogJ3Jlc29sdmUnXG4gICAgICAgIHRoaXMuZGVmZXJbcmVzb2x2ZU1ldGhvZF0ocmVzdWx0KVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBCeSB1c2luZyBmaW5hbGx5IGluIG91ciBuZXh0IG1ldGhvZCB3ZSBvbWl0IHRoZSBkdXR5IHRvIHRocm93IGFuIGV4Y2VwdGlvbiBhbiBzb21lXG4gICAgICAgICAqIHBvaW50LiBUbyBhdm9pZCBwcm9wYWdhdGluZyByZWplY3RlZCBwcm9taXNlcyB1bnRpbCBldmVyeXRoaW5nIGNyYXNoZXMgc2lsZW50bHkgd2VcbiAgICAgICAgICogY2hlY2sgaWYgdGhlIGxhc3QgYW5kIGN1cnJlbnQgcHJvbWlzZSBnb3QgcmVqZWN0ZWQuIElmIHNvIHdlIGNhbiB0aHJvdyB0aGUgZXJyb3IuXG4gICAgICAgICAqL1xuICAgICAgICBpZiAodGhpcy5wcm9taXNlLmlzUmVqZWN0ZWQoKSAmJiAhaXNFcnJvckhhbmRsZWQpIHtcbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogdGFrZSBzY3JlZW5zaG90IG9ubHkgaWYgc2NyZWVuc2hvdFBhdGggaXMgZ2l2ZW5cbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLnNjcmVlbnNob3RQYXRoICE9PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aHJvd0V4Y2VwdGlvbihyZXN1bHQsIHN0YWNrdHJhY2UpXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBzY3JlZW5zaG90UGF0aCA9IHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCBvcHRpb25zLnNjcmVlbnNob3RQYXRoKVxuXG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIHRha2Ugc2NyZWVuc2hvdCBvbmx5IGlmIGRpcmVjdG9yeSBleGlzdHNcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKHNjcmVlbnNob3RQYXRoKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aHJvd0V4Y2VwdGlvbihyZXN1bHQsIHN0YWNrdHJhY2UpXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBjbGllbnQgPSB1bml0KClcbiAgICAgICAgICAgIGNsaWVudC5uZXh0KHByb3RvdHlwZS5zYXZlU2NyZWVuc2hvdCwgW1xuICAgICAgICAgICAgICAgIHBhdGguam9pbihzY3JlZW5zaG90UGF0aCwgJ0VSUk9SXycgKyBzYW5pdGl6ZS5jYXBzKGRlc2lyZWRDYXBhYmlsaXRpZXMpICsgJ18nICsgbmV3IERhdGUoKS50b0pTT04oKSArICcucG5nJylcbiAgICAgICAgICAgIF0sICdzYXZlU2NyZWVuc2hvdCcpXG5cbiAgICAgICAgICAgIGxldCBzdGFjayA9IHN0YWNrdHJhY2Uuc2xpY2UoKVxuICAgICAgICAgICAgcmV0dXJuIHRocm93RXhjZXB0aW9uLmJpbmQobnVsbCwgcmVzdWx0LCBzdGFjaylcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLnByb21pc2VcbiAgICB9XG5cbiAgICBmdW5jdGlvbiB0aHJvd0V4Y2VwdGlvbiAoZSwgc3RhY2spIHtcbiAgICAgICAgc3RhY2sgPSBzdGFjay5zbGljZSgwLCAtMSkubWFwKHRyYWNlID0+ICcgICAgYXQgJyArIHRyYWNlKVxuICAgICAgICBlLnN0YWNrID0gZS50eXBlICsgJzogJyArIGUubWVzc2FnZSArICdcXG4nICsgc3RhY2sucmV2ZXJzZSgpLmpvaW4oJ1xcbicpXG4gICAgICAgIHRocm93IGVcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBXZWJkcml2ZXJJTyBNb25hZFxuICAgICAqL1xuICAgIGZ1bmN0aW9uIHVuaXQgKGxhc3RQcm9taXNlKSB7XG4gICAgICAgIGxldCBjbGllbnQgPSBPYmplY3QuY3JlYXRlKHByb3RvdHlwZSlcbiAgICAgICAgbGV0IGRlZmVyID0gcS5kZWZlcigpXG4gICAgICAgIGxldCBwcm9taXNlID0gZGVmZXIucHJvbWlzZVxuXG4gICAgICAgIGNsaWVudC5kZWZlciA9IGRlZmVyXG4gICAgICAgIGNsaWVudC5wcm9taXNlID0gcHJvbWlzZVxuICAgICAgICBjbGllbnQubGFzdFByb21pc2UgPSBsYXN0UHJvbWlzZSB8fCBmdWxGaWxsZWRQcm9taXNlXG5cbiAgICAgICAgY2xpZW50LmRlc2lyZWRDYXBhYmlsaXRpZXMgPSBkZXNpcmVkQ2FwYWJpbGl0aWVzXG4gICAgICAgIGNsaWVudC5yZXF1ZXN0SGFuZGxlciA9IHJlcXVlc3RIYW5kbGVyXG4gICAgICAgIGNsaWVudC5sb2dnZXIgPSBsb2dnZXJcbiAgICAgICAgY2xpZW50Lm9wdGlvbnMgPSBvcHRpb25zXG4gICAgICAgIGNsaWVudC5pc01vYmlsZSA9IGlzTW9iaWxlXG4gICAgICAgIGNsaWVudC5jb21tYW5kTGlzdCA9IGNvbW1hbmRMaXN0XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIGFjdHVhbCBiaW5kIGZ1bmN0aW9uXG4gICAgICAgICAqL1xuICAgICAgICBjbGllbnQubmV4dCA9IGZ1bmN0aW9uIChmdW5jLCBhcmdzLCBuYW1lKSB7XG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIHVzZSBmaW5hbGx5IHRvIHByb3BhZ2F0ZSByZWplY3RlZCBwcm9taXNlcyB1cCB0aGUgY2hhaW5cbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMubGFzdFByb21pc2UudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgICAgICogc3RvcmUgY29tbWFuZCBpbnRvIGNvbW1hbmQgbGlzdCBzbyBgZ2V0SGlzdG9yeWAgY2FuIHJldHVybiBpdFxuICAgICAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgICAgIGNvbW1hbmRMaXN0LnB1c2goe1xuICAgICAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLFxuICAgICAgICAgICAgICAgICAgICBhcmdzOiBhcmdzXG4gICAgICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlLmNhbGwodGhpcywgc2FmZUV4ZWN1dGUoZnVuYywgYXJncykpXG4gICAgICAgICAgICB9LCAoZSkgPT4ge1xuICAgICAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICAgICAqIHJlamVjdCBwZW5kaW5nIGNvbW1hbmRzIGluIGNoYWluXG4gICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgaWYgKGUuaXNQcm9wYWdhdGVkRXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGVmZXIucmVqZWN0KGUpXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdlcnJvcicsIHtcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogZS5tZXNzYWdlLFxuICAgICAgICAgICAgICAgICAgICB0eXBlOiBlLnR5cGUsXG4gICAgICAgICAgICAgICAgICAgIHN0YWNrOiBzdGFja3RyYWNlXG4gICAgICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICAgICAqIG1hcmsgZXJyb3IgYXMgcHJvcGFnYXRlZCBzbyB0aGF0IGVycm9yIG1lc3NhZ2VzIGdldCBvbmx5IHByaW50ZWQgb25jZVxuICAgICAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgICAgIGUuaXNQcm9wYWdhdGVkRXJyb3IgPSB0cnVlXG4gICAgICAgICAgICAgICAgbG9nZ2VyLnByaW50RXhjZXB0aW9uKGUudHlwZSB8fCAnRXJyb3InLCBlLm1lc3NhZ2UsIHN0YWNrdHJhY2UpXG4gICAgICAgICAgICAgICAgdGhpcy5kZWZlci5yZWplY3QoZSlcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH1cblxuICAgICAgICBjbGllbnQuZmluYWxseSA9IGZ1bmN0aW9uIChmbikge1xuICAgICAgICAgICAgbGV0IGNsaWVudCA9IHVuaXQodGhpcy5wcm9taXNlLmZpbmFsbHkoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlLmNhbGwoY2xpZW50LCBzYWZlRXhlY3V0ZShmbiwgW10pLmJpbmQodGhpcykpXG4gICAgICAgICAgICB9KSlcbiAgICAgICAgICAgIHJldHVybiBjbGllbnRcbiAgICAgICAgfVxuXG4gICAgICAgIGNsaWVudC5jYWxsID0gZnVuY3Rpb24gKGZuKSB7XG4gICAgICAgICAgICBsZXQgY2xpZW50ID0gdW5pdCh0aGlzLnByb21pc2UuZG9uZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUuY2FsbChjbGllbnQsIHNhZmVFeGVjdXRlKGZuLCBbXSkuYmluZCh0aGlzKSlcbiAgICAgICAgICAgIH0pKVxuICAgICAgICAgICAgcmV0dXJuIGNsaWVudFxuICAgICAgICB9XG5cbiAgICAgICAgY2xpZW50LnRoZW4gPSBmdW5jdGlvbiAob25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQpIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygb25GdWxmaWxsZWQgIT09ICdmdW5jdGlvbicgJiYgdHlwZW9mIG9uUmVqZWN0ZWQgIT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIGV4ZWN1dGUgdGhlbiBmdW5jdGlvbiBpbiBjb250ZXh0IG9mIHRoZSBuZXcgaW5zdGFuY2VcbiAgICAgICAgICAgICAqIGJ1dCByZXNvbHZlIHJlc3VsdCB3aXRoIHRoaXNcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgbGV0IGNsaWVudCA9IHVuaXQodGhpcy5wcm9taXNlLnRoZW4oKC4uLmFyZ3MpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZS5jYWxsKGNsaWVudCwgc2FmZUV4ZWN1dGUob25GdWxmaWxsZWQsIGFyZ3MpLmJpbmQodGhpcykpXG4gICAgICAgICAgICB9LCAoLi4uYXJncykgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlLmNhbGwoY2xpZW50LCBzYWZlRXhlY3V0ZShvblJlamVjdGVkLCBhcmdzKS5iaW5kKHRoaXMpLCB0eXBlb2Ygb25SZWplY3RlZCA9PT0gJ2Z1bmN0aW9uJylcbiAgICAgICAgICAgIH0pKVxuXG4gICAgICAgICAgICByZXR1cm4gY2xpZW50XG4gICAgICAgIH1cblxuICAgICAgICBjbGllbnQuY2F0Y2ggPSBmdW5jdGlvbiAob25SZWplY3RlZCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMudGhlbih1bmRlZmluZWQsIG9uUmVqZWN0ZWQpXG4gICAgICAgIH1cblxuICAgICAgICBjbGllbnQuaW5zcGVjdCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnByb21pc2UuaW5zcGVjdCgpXG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogaW50ZXJuYWwgaGVscGVyIG1ldGhvZCB0byBoYW5kbGUgY29tbWFuZCByZXN1bHRzXG4gICAgICAgICAqXG4gICAgICAgICAqIEBwYXJhbSAge1Byb21pc2VbXX0gcHJvbWlzZXMgIGxpc3Qgb2YgcHJvbWlzZXNcbiAgICAgICAgICogQHBhcmFtICB7Qm9vbGVhbn0gICBvcHRpb24gICAgaWYgdHJ1ZSBleHRyYWN0IHZhbHVlIHByb3BlcnR5IGZyb20gc2VsZW5pdW0gcmVzdWx0XG4gICAgICAgICAqL1xuICAgICAgICBjbGllbnQudW5pZnkgPSBmdW5jdGlvbiAocHJvbWlzZXMsIG9wdGlvbikge1xuICAgICAgICAgICAgb3B0aW9uID0gb3B0aW9uIHx8IHt9XG4gICAgICAgICAgICBwcm9taXNlcyA9IEFycmF5LmlzQXJyYXkocHJvbWlzZXMpID8gcHJvbWlzZXMgOiBbcHJvbWlzZXNdXG5cbiAgICAgICAgICAgIHJldHVybiBxLmFsbChwcm9taXNlcylcbiAgICAgICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAgICAgKiBleHRyYWN0IHZhbHVlIHByb3BlcnR5IGZyb20gcmVzdWx0IGlmIGRlc2lyZWRcbiAgICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgICAudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghb3B0aW9uLmV4dHJhY3RWYWx1ZSB8fCAhQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0Lm1hcChyZXMgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgIHJlcy52YWx1ZSAmJiB0eXBlb2YgcmVzLnZhbHVlID09PSAnc3RyaW5nJyA/IHJlcy52YWx1ZS50cmltKCkgOiByZXMudmFsdWUpXG5cbiAgICAgICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAgICAgKiBzYW5pdGl6ZSByZXN1bHQgZm9yIGJldHRlciBhc3NlcnRpb25cbiAgICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgICB9KS50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0KSAmJiByZXN1bHQubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSByZXN1bHRbMF1cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb24ubG93ZXJjYXNlICYmIHR5cGVvZiByZXN1bHQgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSByZXN1bHQudG9Mb3dlckNhc2UoKVxuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdFxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgIH1cblxuICAgICAgICBjbGllbnQuYWRkQ29tbWFuZCA9IGZ1bmN0aW9uIChmbk5hbWUsIGZuLCBmb3JjZU92ZXJ3cml0ZSkge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBuYW1lc3BhY2UgPSBhcmd1bWVudHNbMF1cbiAgICAgICAgICAgICAgICBmbk5hbWUgPSBhcmd1bWVudHNbMV1cbiAgICAgICAgICAgICAgICBmbiA9IGFyZ3VtZW50c1syXVxuICAgICAgICAgICAgICAgIGZvcmNlT3ZlcndyaXRlID0gYXJndW1lbnRzWzNdXG5cbiAgICAgICAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiBjbGllbnRbbmFtZXNwYWNlXSkge1xuICAgICAgICAgICAgICAgIGNhc2UgJ2Z1bmN0aW9uJzpcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcihgQ29tbWFuZCBuYW1lc3BhY2UgXCIke25hbWVzcGFjZX1cIiBpcyB1c2VkIGludGVybmFsbHksIGFuZCBjYW4ndCBiZSBvdmVyd3JpdHRlbiFgKVxuICAgICAgICAgICAgICAgIGNhc2UgJ29iamVjdCc6XG4gICAgICAgICAgICAgICAgICAgIGlmIChjbGllbnRbbmFtZXNwYWNlXVtmbk5hbWVdICYmICFmb3JjZU92ZXJ3cml0ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcihgQ29tbWFuZCBcIiR7Zm5OYW1lfVwiIGlzIGFscmVhZHkgZGVmaW5lZCFgKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB1bml0LmxpZnQobmFtZXNwYWNlLCBmbk5hbWUsIGZuKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoY2xpZW50W2ZuTmFtZV0gJiYgIWZvcmNlT3ZlcndyaXRlKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcihgQ29tbWFuZCBcIiR7Zm5OYW1lfVwiIGlzIGFscmVhZHkgZGVmaW5lZCFgKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHVuaXQubGlmdChmbk5hbWUsIGZuKVxuICAgICAgICB9XG5cbiAgICAgICAgY2xpZW50LnRyYW5zZmVyUHJvbWlzZW5lc3MgPSBmdW5jdGlvbiAodGFyZ2V0LCBwcm9taXNlKSB7XG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIHRyYW5zZmVyIFdlYmRyaXZlcklPIGNvbW1hbmRzXG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIGxldCBjbGllbnRGdW5jdGlvbnMgPSBPYmplY3Qua2V5cyhwcm90b3R5cGUpXG4gICAgICAgICAgICBsZXQgZnVuY3Rpb25zVG9UcmFuZmVyID0gY2xpZW50RnVuY3Rpb25zLmNvbmNhdChQUk9NSVNFX0ZVTkNUSU9OUylcblxuICAgICAgICAgICAgZm9yIChsZXQgZm5OYW1lIG9mIGZ1bmN0aW9uc1RvVHJhbmZlcikge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcHJvbWlzZVtmbk5hbWVdID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgIHRhcmdldFtmbk5hbWVdID0gcHJvbWlzZVtmbk5hbWVdLmJpbmQocHJvbWlzZSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodHlwZW9mIG1vZGlmaWVyID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICBjbGllbnQgPSBtb2RpZmllcihjbGllbnQsIG9wdGlvbnMpXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gY2xpZW50XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogZW5oYW5jZSBiYXNlIG1vbmFkIHByb3RvdHlwZSB3aXRoIG1ldGhvZHNcbiAgICAgKi9cbiAgICB1bml0LmxpZnQgPSBmdW5jdGlvbiAobmFtZSwgZnVuYykge1xuICAgICAgICBsZXQgY29tbWFuZEdyb3VwID0gcHJvdG90eXBlXG5cbiAgICAgICAgaWYgKHR5cGVvZiBmdW5jID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgY29uc3QgbmFtZXNwYWNlID0gYXJndW1lbnRzWzBdXG4gICAgICAgICAgICBuYW1lID0gYXJndW1lbnRzWzFdXG4gICAgICAgICAgICBmdW5jID0gYXJndW1lbnRzWzJdXG5cbiAgICAgICAgICAgIGlmICghcHJvdG90eXBlW25hbWVzcGFjZV0pIHtcbiAgICAgICAgICAgICAgICBwcm90b3R5cGVbbmFtZXNwYWNlXSA9IHt9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbW1hbmRHcm91cCA9IHByb3RvdHlwZVtuYW1lc3BhY2VdXG4gICAgICAgIH1cblxuICAgICAgICBjb21tYW5kR3JvdXBbbmFtZV0gPSBmdW5jdGlvbiAoLi4uYXJncykge1xuICAgICAgICAgICAgbGV0IG5leHRQcm9taXNlID0gdGhpcy5wcm9taXNlXG5cbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogY29tbWFuZHMgZXhlY3V0ZWQgaW5zaWRlIGNvbW1hbmRzIGRvbid0IGhhdmUgdG8gd2FpdFxuICAgICAgICAgICAgICogb24gYW55IHByb21pc2VcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgaWYgKHRoaXMuaXNFeGVjdXRlZCkge1xuICAgICAgICAgICAgICAgIG5leHRQcm9taXNlID0gdGhpcy5sYXN0UHJvbWlzZVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgY2xpZW50ID0gdW5pdChuZXh0UHJvbWlzZSlcblxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBjYXRjaCBzdGFjayB0byBmaW5kIGluZm9ybWF0aW9uIGFib3V0IHdoZXJlIHRoZSBjb21tYW5kIHRoYXQgY2F1c2VzXG4gICAgICAgICAgICAgKiB0aGUgZXJyb3Igd2FzIHVzZWQgKHN0YWNrIGxpbmUgMikgYW5kIG9ubHkgc2F2ZSBpdCB3aGVuIGl0IHdhcyBub3RcbiAgICAgICAgICAgICAqIHdpdGhpbiBXZWJkcml2ZXJJTyBjb250ZXh0XG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIGxldCBzdGFjayA9IG5ldyBFcnJvcigpLnN0YWNrXG4gICAgICAgICAgICBsZXQgbGluZUluVGVzdCA9IHN0YWNrLnNwbGl0KCdcXG4nKS5zbGljZSgyLCAzKS5qb2luKCdcXG4nKVxuICAgICAgICAgICAgbGV0IGZpbGVBbmRQb3NpdGlvbiA9IGxpbmVJblRlc3Quc2xpY2UobGluZUluVGVzdC5pbmRleE9mKCcoJykgKyAxLCBsaW5lSW5UZXN0LmluZGV4T2YoJyknKSlcbiAgICAgICAgICAgIGxldCBhdENvbW1hbmQgPSBsaW5lSW5UZXN0LnRyaW0oKS5zbGljZSgzKS5zcGxpdCgnICcpWzBdXG5cbiAgICAgICAgICAgIGF0Q29tbWFuZCA9IGF0Q29tbWFuZC5zbGljZShhdENvbW1hbmQubGFzdEluZGV4T2YoJy4nKSArIDEpXG5cbiAgICAgICAgICAgIGxldCB0cmFjZSA9IG5hbWUgKyAnKCcgKyBzYW5pdGl6ZS5hcmdzKGFyZ3MpICsgJykgLSAnICsgZmlsZUFuZFBvc2l0aW9uLnNsaWNlKGZpbGVBbmRQb3NpdGlvbi5sYXN0SW5kZXhPZignLycpICsgMSlcbiAgICAgICAgICAgIGlmIChPYmplY3Qua2V5cyhwcm90b3R5cGUpLmluZGV4T2YoYXRDb21tYW5kKSA9PT0gLTEgJiYgYXRDb21tYW5kICE9PSAnZXhwb3J0cycpIHtcbiAgICAgICAgICAgICAgICBzdGFja3RyYWNlID0gW3RyYWNlXVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAgICAgKiBzYXZlIHRyYWNlIGZvciBuZXN0ZWQgY29tbWFuZHNcbiAgICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgICBzdGFja3RyYWNlLnB1c2godHJhY2UpXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogcXVldWUgY29tbWFuZFxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICBjbGllbnQubmV4dChmdW5jLCBhcmdzLCBuYW1lKVxuICAgICAgICAgICAgcmV0dXJuIGNsaWVudFxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHVuaXRcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiByZWdpc3RlciBldmVudCBlbWl0dGVyXG4gICAgICovXG4gICAgZm9yIChsZXQgZXZlbnRDb21tYW5kIGluIEVWRU5USEFORExFUl9GVU5DSU9OUykge1xuICAgICAgICBwcm90b3R5cGVbZXZlbnRDb21tYW5kXSA9IGZ1bmN0aW9uICguLi5hcmdzKSB7XG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIGN1c3RvbSBjb21tYW5kcyBuZWVkcyB0byBnZXQgZW1pdHRlZCBhbmQgcmVnaXN0ZXJlZCBpbiBvcmRlclxuICAgICAgICAgICAgICogdG8gcHJldmVudCByYWNlIGNvbmRpdGlvbnNcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgaWYgKElOVEVSTkFMX0VWRU5UUy5pbmRleE9mKGFyZ3NbMF0pID09PSAtMSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZpbmFsbHkoKCkgPT4gZXZlbnRIYW5kbGVyW2V2ZW50Q29tbWFuZF0uYXBwbHkoZXZlbnRIYW5kbGVyLCBhcmdzKSlcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZXZlbnRIYW5kbGVyW2V2ZW50Q29tbWFuZF0uYXBwbHkoZXZlbnRIYW5kbGVyLCBhcmdzKVxuICAgICAgICAgICAgcmV0dXJuIHRoaXNcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB1bml0XG59XG5cbmV4cG9ydCBkZWZhdWx0IFdlYmRyaXZlcklPXG4iXX0=
