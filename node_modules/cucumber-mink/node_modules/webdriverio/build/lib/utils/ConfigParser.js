'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
    value: true
});

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _glob = require('glob');

var _glob2 = _interopRequireDefault(_glob);

var _deepmerge = require('deepmerge');

var _deepmerge2 = _interopRequireDefault(_deepmerge);

var _helpersDetectSeleniumBackend = require('../helpers/detectSeleniumBackend');

var _helpersDetectSeleniumBackend2 = _interopRequireDefault(_helpersDetectSeleniumBackend);

var DEFAULT_TIMEOUT = 10000;
var NOOP = function NOOP() {};
var DEFAULT_CONFIGS = {
    specs: [],
    exclude: [],
    logLevel: 'silent',
    coloredLogs: true,
    baseUrl: null,
    waitforTimeout: 1000,
    framework: 'mocha',
    reporter: 'dot',
    maxInstances: 1,

    /**
     * framework defaults
     */
    mochaOpts: {
        timeout: DEFAULT_TIMEOUT
    },
    jasmineNodeOpts: {
        defaultTimeoutInterval: DEFAULT_TIMEOUT
    },

    /**
     * hooks
     */
    onPrepare: NOOP,
    before: NOOP,
    beforeSuite: NOOP,
    beforeHook: NOOP,
    beforeTest: NOOP,
    beforeCommand: NOOP,
    afterCommand: NOOP,
    afterTest: NOOP,
    afterHook: NOOP,
    afterSuite: NOOP,
    after: NOOP,
    onComplete: NOOP
};

var ConfigParser = (function () {
    function ConfigParser() {
        _classCallCheck(this, ConfigParser);

        this._config = DEFAULT_CONFIGS;
        this._capabilities = [];
    }

    /**
     * merges config file with default values
     * @param {String} filename path of file relative to current directory
     */

    _createClass(ConfigParser, [{
        key: 'addConfigFile',
        value: function addConfigFile(filename) {
            if (typeof filename !== 'string') {
                throw new Error('addConfigFile requires filepath');
            }

            var filePath = _path2['default'].resolve(process.cwd(), filename);

            try {
                var fileConfig = require(filePath).config;

                if (typeof fileConfig !== 'object') {
                    throw new Error('configuration file exports no config object');
                }

                /**
                 * merge capabilities
                 */
                this._capabilities = (0, _deepmerge2['default'])(this._capabilities, fileConfig.capabilities);
                delete fileConfig.capabilities;

                this._config = (0, _deepmerge2['default'])(this._config, fileConfig);

                /**
                 * detect Selenium backend
                 */
                this._config = (0, _deepmerge2['default'])((0, _helpersDetectSeleniumBackend2['default'])(this._config), this._config);
            } catch (e) {
                console.error('Failed loading configuration file: ', filePath);
                throw e;
            }
        }

        /**
         * merge external object with config object
         * @param  {Object} object  desired object to merge into the config object
         */
    }, {
        key: 'merge',
        value: function merge(object) {
            this._config = (0, _deepmerge2['default'])(this._config, object);

            /**
             * user and key could get added via cli arguments so we need to detect again
             * Note: cli arguments are on the right and overwrite config
             */
            this._config = (0, _deepmerge2['default'])((0, _helpersDetectSeleniumBackend2['default'])(this._config), this._config);
        }

        /**
         * get excluded files from config pattern
         */
    }, {
        key: 'getSpecs',
        value: function getSpecs(capSpecs, capExclude) {
            var specs = ConfigParser.getFilePaths(this._config.specs);
            var exclude = ConfigParser.getFilePaths(this._config.exclude);

            if (Array.isArray(capSpecs)) {
                specs = specs.concat(capSpecs);
            }
            if (Array.isArray(capExclude)) {
                exclude = exclude.concat(capExclude);
            }

            return specs.filter(function (spec) {
                return exclude.indexOf(spec) < 0;
            });
        }

        /**
         * return configs
         */
    }, {
        key: 'getConfig',
        value: function getConfig() {
            return this._config;
        }

        /**
         * return capabilities
         */
    }, {
        key: 'getCapabilities',
        value: function getCapabilities(i) {
            if (typeof i === 'number' && this._capabilities[i]) {
                return this._capabilities[i];
            }

            return this._capabilities;
        }

        /**
         * returns a flatten list of globed files
         *
         * @param  {String[]} filenames  list of files to glob
         * @return {String[]} list of files
         */
    }], [{
        key: 'getFilePaths',
        value: function getFilePaths(patterns, omitWarnings) {
            var files = [];

            var _iteratorNormalCompletion = true;
            var _didIteratorError = false;
            var _iteratorError = undefined;

            try {
                for (var _iterator = _getIterator(patterns), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                    var pattern = _step.value;

                    var filenames = _glob2['default'].sync(pattern);

                    filenames = filenames.filter(function (path) {
                        return path.slice(-3) === '.js' || path.slice(-8) === '.feature' || path.slice(-7) === '.coffee';
                    });

                    filenames = filenames.map(function (path) {
                        return process.cwd() + '/' + path;
                    });

                    if (filenames.length === 0 && !omitWarnings) {
                        console.warn('pattern', pattern, 'did not match any file');
                    }

                    files = (0, _deepmerge2['default'])(files, filenames);
                }
            } catch (err) {
                _didIteratorError = true;
                _iteratorError = err;
            } finally {
                try {
                    if (!_iteratorNormalCompletion && _iterator['return']) {
                        _iterator['return']();
                    }
                } finally {
                    if (_didIteratorError) {
                        throw _iteratorError;
                    }
                }
            }

            return files;
        }
    }]);

    return ConfigParser;
})();

exports['default'] = ConfigParser;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi91dGlscy9Db25maWdQYXJzZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7b0JBQWlCLE1BQU07Ozs7b0JBQ04sTUFBTTs7Ozt5QkFDTCxXQUFXOzs7OzRDQUVLLGtDQUFrQzs7OztBQUVwRSxJQUFNLGVBQWUsR0FBRyxLQUFLLENBQUE7QUFDN0IsSUFBTSxJQUFJLEdBQUcsU0FBUCxJQUFJLEdBQWUsRUFBRSxDQUFBO0FBQzNCLElBQU0sZUFBZSxHQUFHO0FBQ3BCLFNBQUssRUFBRSxFQUFFO0FBQ1QsV0FBTyxFQUFFLEVBQUU7QUFDWCxZQUFRLEVBQUUsUUFBUTtBQUNsQixlQUFXLEVBQUUsSUFBSTtBQUNqQixXQUFPLEVBQUUsSUFBSTtBQUNiLGtCQUFjLEVBQUUsSUFBSTtBQUNwQixhQUFTLEVBQUUsT0FBTztBQUNsQixZQUFRLEVBQUUsS0FBSztBQUNmLGdCQUFZLEVBQUUsQ0FBQzs7Ozs7QUFLZixhQUFTLEVBQUU7QUFDUCxlQUFPLEVBQUUsZUFBZTtLQUMzQjtBQUNELG1CQUFlLEVBQUU7QUFDYiw4QkFBc0IsRUFBRSxlQUFlO0tBQzFDOzs7OztBQUtELGFBQVMsRUFBRSxJQUFJO0FBQ2YsVUFBTSxFQUFFLElBQUk7QUFDWixlQUFXLEVBQUUsSUFBSTtBQUNqQixjQUFVLEVBQUUsSUFBSTtBQUNoQixjQUFVLEVBQUUsSUFBSTtBQUNoQixpQkFBYSxFQUFFLElBQUk7QUFDbkIsZ0JBQVksRUFBRSxJQUFJO0FBQ2xCLGFBQVMsRUFBRSxJQUFJO0FBQ2YsYUFBUyxFQUFFLElBQUk7QUFDZixjQUFVLEVBQUUsSUFBSTtBQUNoQixTQUFLLEVBQUUsSUFBSTtBQUNYLGNBQVUsRUFBRSxJQUFJO0NBQ25CLENBQUE7O0lBRUssWUFBWTtBQUNGLGFBRFYsWUFBWSxHQUNDOzhCQURiLFlBQVk7O0FBRVYsWUFBSSxDQUFDLE9BQU8sR0FBRyxlQUFlLENBQUE7QUFDOUIsWUFBSSxDQUFDLGFBQWEsR0FBRyxF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QW9CLFFBQVEsNEdBQUU7d0JBQXJCLE9BQU87O0FBQ1osd0JBQUksU0FBUyxHQUFHLGtCQUFLLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTs7QUFFbEMsNkJBQVMsR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDLFVBQUEsSUFBSTsrQkFDN0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEtBQUssSUFDeEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLFVBQVUsSUFDN0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLFNBQVM7cUJBQUEsQ0FBQyxDQUFBOztBQUVqQyw2QkFBUyxHQUFHLFNBQVMsQ0FBQyxHQUFHLENBQUMsVUFBQSxJQUFJOytCQUMxQixPQUFPLENBQUMsR0FBRyxFQUFFLEdBQUcsR0FBRyxHQUFHLElBQUk7cUJBQUEsQ0FBQyxDQUFBOztBQUUvQix3QkFBSSxTQUFTLENBQUMsTUFBTSxLQUFLLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRTtBQUN6QywrQkFBTyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsT0FBTyxFQUFFLHdCQUF3QixDQUFDLENBQUE7cUJBQzdEOztBQUVELHlCQUFLLEdBQUcsNEJBQU0sS0FBSyxFQUFFLFNBQVMsQ0FBQyxDQUFBO2lCQUNsQzs7Ozs7Ozs7Ozs7Ozs7OztBQUVELG1CQUFPLEtBQUssQ0FBQTtTQUNmOzs7V0F2SEMsWUFBWTs7O3FCQTBISCxZQUFZIiwiZmlsZSI6IkNvbmZpZ1BhcnNlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwYXRoIGZyb20gJ3BhdGgnXG5pbXBvcnQgZ2xvYiBmcm9tICdnbG9iJ1xuaW1wb3J0IG1lcmdlIGZyb20gJ2RlZXBtZXJnZSdcblxuaW1wb3J0IGRldGVjdFNlbGVuaXVtQmFja2VuZCBmcm9tICcuLi9oZWxwZXJzL2RldGVjdFNlbGVuaXVtQmFja2VuZCdcblxuY29uc3QgREVGQVVMVF9USU1FT1VUID0gMTAwMDBcbmNvbnN0IE5PT1AgPSBmdW5jdGlvbiAoKSB7fVxuY29uc3QgREVGQVVMVF9DT05GSUdTID0ge1xuICAgIHNwZWNzOiBbXSxcbiAgICBleGNsdWRlOiBbXSxcbiAgICBsb2dMZXZlbDogJ3NpbGVudCcsXG4gICAgY29sb3JlZExvZ3M6IHRydWUsXG4gICAgYmFzZVVybDogbnVsbCxcbiAgICB3YWl0Zm9yVGltZW91dDogMTAwMCxcbiAgICBmcmFtZXdvcms6ICdtb2NoYScsXG4gICAgcmVwb3J0ZXI6ICdkb3QnLFxuICAgIG1heEluc3RhbmNlczogMSxcblxuICAgIC8qKlxuICAgICAqIGZyYW1ld29yayBkZWZhdWx0c1xuICAgICAqL1xuICAgIG1vY2hhT3B0czoge1xuICAgICAgICB0aW1lb3V0OiBERUZBVUxUX1RJTUVPVVRcbiAgICB9LFxuICAgIGphc21pbmVOb2RlT3B0czoge1xuICAgICAgICBkZWZhdWx0VGltZW91dEludGVydmFsOiBERUZBVUxUX1RJTUVPVVRcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogaG9va3NcbiAgICAgKi9cbiAgICBvblByZXBhcmU6IE5PT1AsXG4gICAgYmVmb3JlOiBOT09QLFxuICAgIGJlZm9yZVN1aXRlOiBOT09QLFxuICAgIGJlZm9yZUhvb2s6IE5PT1AsXG4gICAgYmVmb3JlVGVzdDogTk9PUCxcbiAgICBiZWZvcmVDb21tYW5kOiBOT09QLFxuICAgIGFmdGVyQ29tbWFuZDogTk9PUCxcbiAgICBhZnRlclRlc3Q6IE5PT1AsXG4gICAgYWZ0ZXJIb29rOiBOT09QLFxuICAgIGFmdGVyU3VpdGU6IE5PT1AsXG4gICAgYWZ0ZXI6IE5PT1AsXG4gICAgb25Db21wbGV0ZTogTk9PUFxufVxuXG5jbGFzcyBDb25maWdQYXJzZXIge1xuICAgIGNvbnN0cnVjdG9yICgpIHtcbiAgICAgICAgdGhpcy5fY29uZmlnID0gREVGQVVMVF9DT05GSUdTXG4gICAgICAgIHRoaXMuX2NhcGFiaWxpdGllcyA9IFtdXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogbWVyZ2VzIGNvbmZpZyBmaWxlIHdpdGggZGVmYXVsdCB2YWx1ZXNcbiAgICAgKiBAcGFyYW0ge1N0cmluZ30gZmlsZW5hbWUgcGF0aCBvZiBmaWxlIHJlbGF0aXZlIHRvIGN1cnJlbnQgZGlyZWN0b3J5XG4gICAgICovXG4gICAgYWRkQ29uZmlnRmlsZSAoZmlsZW5hbWUpIHtcbiAgICAgICAgaWYgKHR5cGVvZiBmaWxlbmFtZSAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignYWRkQ29uZmlnRmlsZSByZXF1aXJlcyBmaWxlcGF0aCcpXG4gICAgICAgIH1cblxuICAgICAgICB2YXIgZmlsZVBhdGggPSBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgZmlsZW5hbWUpXG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHZhciBmaWxlQ29uZmlnID0gcmVxdWlyZShmaWxlUGF0aCkuY29uZmlnXG5cbiAgICAgICAgICAgIGlmICh0eXBlb2YgZmlsZUNvbmZpZyAhPT0gJ29iamVjdCcpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2NvbmZpZ3VyYXRpb24gZmlsZSBleHBvcnRzIG5vIGNvbmZpZyBvYmplY3QnKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIG1lcmdlIGNhcGFiaWxpdGllc1xuICAgICAgICAgICAgICovXG4gICAgICAgICAgICB0aGlzLl9jYXBhYmlsaXRpZXMgPSBtZXJnZSh0aGlzLl9jYXBhYmlsaXRpZXMsIGZpbGVDb25maWcuY2FwYWJpbGl0aWVzKVxuICAgICAgICAgICAgZGVsZXRlIGZpbGVDb25maWcuY2FwYWJpbGl0aWVzXG5cbiAgICAgICAgICAgIHRoaXMuX2NvbmZpZyA9IG1lcmdlKHRoaXMuX2NvbmZpZywgZmlsZUNvbmZpZylcblxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBkZXRlY3QgU2VsZW5pdW0gYmFja2VuZFxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICB0aGlzLl9jb25maWcgPSBtZXJnZShkZXRlY3RTZWxlbml1bUJhY2tlbmQodGhpcy5fY29uZmlnKSwgdGhpcy5fY29uZmlnKVxuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgbG9hZGluZyBjb25maWd1cmF0aW9uIGZpbGU6ICcsIGZpbGVQYXRoKVxuICAgICAgICAgICAgdGhyb3cgZVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogbWVyZ2UgZXh0ZXJuYWwgb2JqZWN0IHdpdGggY29uZmlnIG9iamVjdFxuICAgICAqIEBwYXJhbSAge09iamVjdH0gb2JqZWN0ICBkZXNpcmVkIG9iamVjdCB0byBtZXJnZSBpbnRvIHRoZSBjb25maWcgb2JqZWN0XG4gICAgICovXG4gICAgbWVyZ2UgKG9iamVjdCkge1xuICAgICAgICB0aGlzLl9jb25maWcgPSBtZXJnZSh0aGlzLl9jb25maWcsIG9iamVjdClcblxuICAgICAgICAvKipcbiAgICAgICAgICogdXNlciBhbmQga2V5IGNvdWxkIGdldCBhZGRlZCB2aWEgY2xpIGFyZ3VtZW50cyBzbyB3ZSBuZWVkIHRvIGRldGVjdCBhZ2FpblxuICAgICAgICAgKiBOb3RlOiBjbGkgYXJndW1lbnRzIGFyZSBvbiB0aGUgcmlnaHQgYW5kIG92ZXJ3cml0ZSBjb25maWdcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuX2NvbmZpZyA9IG1lcmdlKGRldGVjdFNlbGVuaXVtQmFja2VuZCh0aGlzLl9jb25maWcpLCB0aGlzLl9jb25maWcpXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogZ2V0IGV4Y2x1ZGVkIGZpbGVzIGZyb20gY29uZmlnIHBhdHRlcm5cbiAgICAgKi9cbiAgICBnZXRTcGVjcyAoY2FwU3BlY3MsIGNhcEV4Y2x1ZGUpIHtcbiAgICAgICAgbGV0IHNwZWNzID0gQ29uZmlnUGFyc2VyLmdldEZpbGVQYXRocyh0aGlzLl9jb25maWcuc3BlY3MpXG4gICAgICAgIGxldCBleGNsdWRlID0gQ29uZmlnUGFyc2VyLmdldEZpbGVQYXRocyh0aGlzLl9jb25maWcuZXhjbHVkZSlcblxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShjYXBTcGVjcykpIHtcbiAgICAgICAgICAgIHNwZWNzID0gc3BlY3MuY29uY2F0KGNhcFNwZWNzKVxuICAgICAgICB9XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KGNhcEV4Y2x1ZGUpKSB7XG4gICAgICAgICAgICBleGNsdWRlID0gZXhjbHVkZS5jb25jYXQoY2FwRXhjbHVkZSlcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBzcGVjcy5maWx0ZXIoc3BlYyA9PiBleGNsdWRlLmluZGV4T2Yoc3BlYykgPCAwKVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIHJldHVybiBjb25maWdzXG4gICAgICovXG4gICAgZ2V0Q29uZmlnICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2NvbmZpZ1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIHJldHVybiBjYXBhYmlsaXRpZXNcbiAgICAgKi9cbiAgICBnZXRDYXBhYmlsaXRpZXMgKGkpIHtcbiAgICAgICAgaWYgKHR5cGVvZiBpID09PSAnbnVtYmVyJyAmJiB0aGlzLl9jYXBhYmlsaXRpZXNbaV0pIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9jYXBhYmlsaXRpZXNbaV1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLl9jYXBhYmlsaXRpZXNcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiByZXR1cm5zIGEgZmxhdHRlbiBsaXN0IG9mIGdsb2JlZCBmaWxlc1xuICAgICAqXG4gICAgICogQHBhcmFtICB7U3RyaW5nW119IGZpbGVuYW1lcyAgbGlzdCBvZiBmaWxlcyB0byBnbG9iXG4gICAgICogQHJldHVybiB7U3RyaW5nW119IGxpc3Qgb2YgZmlsZXNcbiAgICAgKi9cbiAgICBzdGF0aWMgZ2V0RmlsZVBhdGhzIChwYXR0ZXJucywgb21pdFdhcm5pbmdzKSB7XG4gICAgICAgIGxldCBmaWxlcyA9IFtdXG5cbiAgICAgICAgZm9yIChsZXQgcGF0dGVybiBvZiBwYXR0ZXJucykge1xuICAgICAgICAgICAgbGV0IGZpbGVuYW1lcyA9IGdsb2Iuc3luYyhwYXR0ZXJuKVxuXG4gICAgICAgICAgICBmaWxlbmFtZXMgPSBmaWxlbmFtZXMuZmlsdGVyKHBhdGggPT5cbiAgICAgICAgICAgICAgICBwYXRoLnNsaWNlKC0zKSA9PT0gJy5qcycgfHxcbiAgICAgICAgICAgICAgICBwYXRoLnNsaWNlKC04KSA9PT0gJy5mZWF0dXJlJyB8fFxuICAgICAgICAgICAgICAgIHBhdGguc2xpY2UoLTcpID09PSAnLmNvZmZlZScpXG5cbiAgICAgICAgICAgIGZpbGVuYW1lcyA9IGZpbGVuYW1lcy5tYXAocGF0aCA9PlxuICAgICAgICAgICAgICAgIHByb2Nlc3MuY3dkKCkgKyAnLycgKyBwYXRoKVxuXG4gICAgICAgICAgICBpZiAoZmlsZW5hbWVzLmxlbmd0aCA9PT0gMCAmJiAhb21pdFdhcm5pbmdzKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdwYXR0ZXJuJywgcGF0dGVybiwgJ2RpZCBub3QgbWF0Y2ggYW55IGZpbGUnKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmaWxlcyA9IG1lcmdlKGZpbGVzLCBmaWxlbmFtZXMpXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZmlsZXNcbiAgICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IENvbmZpZ1BhcnNlclxuIl19
