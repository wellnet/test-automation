'use strict';

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
    value: true
});

var _helpersFindElementStrategy = require('../helpers/findElementStrategy');

var _helpersFindElementStrategy2 = _interopRequireDefault(_helpersFindElementStrategy);

/**
 * Returns the script to execute in the browser, in string format.
 * @param {Function|String} fn - function to execute in the browser
 * @param {Array.<String>} selectors - the selectors to resolve and pass to fn, each in its own array
 * @param {Array} args - the arguments to pass to fn (after resolved selectors)
 * @param {Function} callback
 * @returns {string}
 */
var createSelectorScript = function createSelectorScript(fn, selectors, args) {
    var strArgs = [];
    var foundSel = [];

    if (typeof fn === 'function' || this.inMultibrowserMode && fn.indexOf('function (') === 0) {
        // Handle function script
        strArgs.push(fn.toString());
    } else if (typeof fn === 'string') {
        // Handle string script
        strArgs.push('function(){' + fn + '}');
    }

    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
        for (var _iterator = _getIterator(selectors), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
            var selector = _step.value;

            var val = (0, _helpersFindElementStrategy2['default'])(selector);
            foundSel.push(val.using, val.value);
        }
    } catch (err) {
        _didIteratorError = true;
        _iteratorError = err;
    } finally {
        try {
            if (!_iteratorNormalCompletion && _iterator['return']) {
                _iterator['return']();
            }
        } finally {
            if (_didIteratorError) {
                throw _iteratorError;
            }
        }
    }

    strArgs.push(JSON.stringify(foundSel));

    var i = -1;
    while (++i < args.length) {
        if (typeof args[i] === 'function' || this.inMultibrowserMode && typeof args[i] === 'string' && args[i].indexOf('function (') === 0) {
            args[i] = args[i].toString();
        } else {
            args[i] = JSON.stringify(args[i]);
        }
    }
    strArgs.push('[' + args.join(',') + ']');

    return ('return (' + executeClientSide + ')(' + strArgs.join(',') + ', arguments[arguments.length - 1]);').replace(/(\s{4}|\t)+/g, ' ');
};

/**
 * Helper that resolves selectors client side and returns the result in the given fn.
 * Every resolved selector is prepended to the function's arguments.
 * Each resolved selector yields a single array.
 *
 * @param {Function} fn - the function to execute client side that will receive the resolved selectors
 * @param {Array.<String>} sArr - a series of usage, value pairs from find-element-strategy
 * @param {Array} args - any other arguments to pass to fn
 * @returns {*} the return value of fn
 * @example
 * var helper = require('./executeClientSideSelector');
 * // Execute in the browser
 * helper(fn, ['xpath', '//body', 'css', '[id="what"]'], [1, 2, 3]);
 * // Assuming fn is...
 * fn = function(xpathResult, cssResult, one, two, three) {
 *     console.log(xpathResult.length); // 1
 *     console.log(xpathResult[0]);     // <body.../>
 *     console.log(cssResult.length);   // 0
 *     console.log(one, two, three);    // 1 2 3
 * }
 */
var executeClientSide = function executeClientSide(fn, sArr, args) {
    var cb = arguments[arguments.length - 1],
        i = 0,
        sArgs = [],
        use,
        value,
        xp,
        cs,
        tn,
        res,
        j,
        arg;

    if (typeof document.querySelectorAll === 'undefined') {
        document.querySelectorAll = function (selector) {
            var doc = document,
                head = doc.documentElement.firstChild,
                styleTag = doc.createElement('STYLE');
            head.appendChild(styleTag);
            doc.__qsaels = [];

            styleTag.styleSheet.cssText = selector + '{x:expression(document.__qsaels.push(this))}';
            window.scrollBy(0, 0);

            return doc.__qsaels;
        };
    }

    while ((use = sArr[i++]) && (value = sArr[i++])) {
        arg = [];
        xp = cs = tn = null;
        switch (use) {
            case 'partial link text':
                xp = '//a[contains(text(),"' + value + '")]';
                break;
            case 'link text':
                xp = '//a[text()="' + value + '"]';
                break;
            case 'xpath':
                xp = value;
                break;
            case 'id':
                cs = '#' + value;
                break;
            case 'name':
                cs = '[name="' + value + '"]';
                break;
            case 'tag name':
                tn = value;
                break;
            case 'css selector':
                cs = value;
                break;
            default:
                throw new Error('Could not evaluate selector: Invalid strategy ' + use);
        }

        if (xp) {
            res = document.evaluate(xp, document, null, 0, null);

            value = res.iterateNext();
            while (value) {
                arg.push(value);
                value = res.iterateNext();
            }
        } else if (tn || cs) {
            res = tn ? document.getElementsByTagName(tn) : document.querySelectorAll(cs);
            for (j = 0; j < res.length; ++j) {
                arg.push(res[j]);
            }
        }
        sArgs.push(arg);
    }

    var parameter = args && sArgs.concat(args) || sArgs;
    if (parameter.length === 0 || parameter.length === 1 && parameter[0].length === 0) {
        if (typeof cb === 'function') {
            return cb('NoSuchElement') && new Error('NoSuchElement');
        }
        return new Error('NoSuchElement');
    }

    parameter.push(arguments[arguments.length - 1]);

    return fn.apply(window, parameter);
};

exports['default'] = createSelectorScript;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9zY3JpcHRzL2NyZWF0ZVNlbGVjdG9yU2NyaXB0LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7MENBQXlCLGdDQUFnQzs7Ozs7Ozs7Ozs7O0FBVXpELElBQUksb0JBQW9CLEdBQUcsU0FBdkIsb0JBQW9CLENBQWEsRUFBRSxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUU7QUFDdEQsUUFBSSxPQUFPLEdBQUcsRUFBRSxDQUFBO0FBQ2hCLFFBQUksUUFBUSxHQUFHLEVBQUUsQ0FBQTs7QUFFakIsUUFBSSxPQUFPLEVBQUUsS0FBSyxVQUFVLElBQUssSUFBSSxDQUFDLGtCQUFrQixJQUFJLEVBQUUsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxBQUFDLEVBQUU7O0FBRXpGLGVBQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUE7S0FDOUIsTUFBTSxJQUFJLE9BQU8sRUFBRSxLQUFLLFFBQVEsRUFBRTs7QUFFL0IsZUFBTyxDQUFDLElBQUksaUJBQWUsRUFBRSxPQUFJLENBQUE7S0FDcEM7Ozs7Ozs7QUFFRCwwQ0FBcUIsU0FBUyw0R0FBRTtnQkFBdkIsUUFBUTs7QUFDYixnQkFBSSxHQUFHLEdBQUcsNkNBQWEsUUFBUSxDQUFDLENBQUE7QUFDaEMsb0JBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUE7U0FDdEM7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFRCxXQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQTs7QUFFdEMsUUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7QUFDVixXQUFPLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUU7QUFDdEIsWUFBSSxPQUFPLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxVQUFVLElBQUssSUFBSSxD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QUMsTUFBTSxLQUFLLENBQUMsSUFBSSxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxLQUFLLENBQUMsQUFBQyxFQUFFO0FBQ2hGLFlBQUcsT0FBTyxFQUFFLEtBQUssVUFBVSxFQUFFO0FBQ3pCLG1CQUFPLEVBQUUsQ0FBQyxlQUFlLENBQUMsSUFBSSxJQUFJLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQztTQUM1RDtBQUNELGVBQU8sSUFBSSxLQUFLLENBQUMsZUFBZSxDQUFDLENBQUM7S0FDckM7O0FBRUQsYUFBUyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDOztBQUVoRCxXQUFPLEVBQUUsQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0NBQ3RDLENBQUM7O3FCQUVhLG9CQUFvQiIsImZpbGUiOiJjcmVhdGVTZWxlY3RvclNjcmlwdC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmaW5kU3RyYXRlZ3kgZnJvbSAnLi4vaGVscGVycy9maW5kRWxlbWVudFN0cmF0ZWd5J1xuXG4vKipcbiAqIFJldHVybnMgdGhlIHNjcmlwdCB0byBleGVjdXRlIGluIHRoZSBicm93c2VyLCBpbiBzdHJpbmcgZm9ybWF0LlxuICogQHBhcmFtIHtGdW5jdGlvbnxTdHJpbmd9IGZuIC0gZnVuY3Rpb24gdG8gZXhlY3V0ZSBpbiB0aGUgYnJvd3NlclxuICogQHBhcmFtIHtBcnJheS48U3RyaW5nPn0gc2VsZWN0b3JzIC0gdGhlIHNlbGVjdG9ycyB0byByZXNvbHZlIGFuZCBwYXNzIHRvIGZuLCBlYWNoIGluIGl0cyBvd24gYXJyYXlcbiAqIEBwYXJhbSB7QXJyYXl9IGFyZ3MgLSB0aGUgYXJndW1lbnRzIHRvIHBhc3MgdG8gZm4gKGFmdGVyIHJlc29sdmVkIHNlbGVjdG9ycylcbiAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrXG4gKiBAcmV0dXJucyB7c3RyaW5nfVxuICovXG5sZXQgY3JlYXRlU2VsZWN0b3JTY3JpcHQgPSBmdW5jdGlvbiAoZm4sIHNlbGVjdG9ycywgYXJncykge1xuICAgIGxldCBzdHJBcmdzID0gW11cbiAgICBsZXQgZm91bmRTZWwgPSBbXVxuXG4gICAgaWYgKHR5cGVvZiBmbiA9PT0gJ2Z1bmN0aW9uJyB8fCAodGhpcy5pbk11bHRpYnJvd3Nlck1vZGUgJiYgZm4uaW5kZXhPZignZnVuY3Rpb24gKCcpID09PSAwKSkge1xuICAgICAgICAvLyBIYW5kbGUgZnVuY3Rpb24gc2NyaXB0XG4gICAgICAgIHN0ckFyZ3MucHVzaChmbi50b1N0cmluZygpKVxuICAgIH0gZWxzZSBpZiAodHlwZW9mIGZuID09PSAnc3RyaW5nJykge1xuICAgICAgICAvLyBIYW5kbGUgc3RyaW5nIHNjcmlwdFxuICAgICAgICBzdHJBcmdzLnB1c2goYGZ1bmN0aW9uKCl7JHtmbn19YClcbiAgICB9XG5cbiAgICBmb3IgKGxldCBzZWxlY3RvciBvZiBzZWxlY3RvcnMpIHtcbiAgICAgICAgbGV0IHZhbCA9IGZpbmRTdHJhdGVneShzZWxlY3RvcilcbiAgICAgICAgZm91bmRTZWwucHVzaCh2YWwudXNpbmcsIHZhbC52YWx1ZSlcbiAgICB9XG5cbiAgICBzdHJBcmdzLnB1c2goSlNPTi5zdHJpbmdpZnkoZm91bmRTZWwpKVxuXG4gICAgdmFyIGkgPSAtMVxuICAgIHdoaWxlICgrK2kgPCBhcmdzLmxlbmd0aCkge1xuICAgICAgICBpZiAodHlwZW9mIGFyZ3NbaV0gPT09ICdmdW5jdGlvbicgfHwgKHRoaXMuaW5NdWx0aWJyb3dzZXJNb2RlICYmICh0eXBlb2YgYXJnc1tpXSA9PT0gJ3N0cmluZycgJiYgYXJnc1tpXS5pbmRleE9mKCdmdW5jdGlvbiAoJykgPT09IDApKSkge1xuICAgICAgICAgICAgYXJnc1tpXSA9IGFyZ3NbaV0udG9TdHJpbmcoKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYXJnc1tpXSA9IEpTT04uc3RyaW5naWZ5KGFyZ3NbaV0pXG4gICAgICAgIH1cbiAgICB9XG4gICAgc3RyQXJncy5wdXNoKCdbJyArIGFyZ3Muam9pbignLCcpICsgJ10nKVxuXG4gICAgcmV0dXJuIChgcmV0dXJuICgke2V4ZWN1dGVDbGllbnRTaWRlfSkoJHtzdHJBcmdzLmpvaW4oJywnKX0sIGFyZ3VtZW50c1thcmd1bWVudHMubGVuZ3RoIC0gMV0pO2ApLnJlcGxhY2UoLyhcXHN7NH18XFx0KSsvZywgJyAnKVxufVxuXG4vKipcbiAqIEhlbHBlciB0aGF0IHJlc29sdmVzIHNlbGVjdG9ycyBjbGllbnQgc2lkZSBhbmQgcmV0dXJucyB0aGUgcmVzdWx0IGluIHRoZSBnaXZlbiBmbi5cbiAqIEV2ZXJ5IHJlc29sdmVkIHNlbGVjdG9yIGlzIHByZXBlbmRlZCB0byB0aGUgZnVuY3Rpb24ncyBhcmd1bWVudHMuXG4gKiBFYWNoIHJlc29sdmVkIHNlbGVjdG9yIHlpZWxkcyBhIHNpbmdsZSBhcnJheS5cbiAqXG4gKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiAtIHRoZSBmdW5jdGlvbiB0byBleGVjdXRlIGNsaWVudCBzaWRlIHRoYXQgd2lsbCByZWNlaXZlIHRoZSByZXNvbHZlZCBzZWxlY3RvcnNcbiAqIEBwYXJhbSB7QXJyYXkuPFN0cmluZz59IHNBcnIgLSBhIHNlcmllcyBvZiB1c2FnZSwgdmFsdWUgcGFpcnMgZnJvbSBmaW5kLWVsZW1lbnQtc3RyYXRlZ3lcbiAqIEBwYXJhbSB7QXJyYXl9IGFyZ3MgLSBhbnkgb3RoZXIgYXJndW1lbnRzIHRvIHBhc3MgdG8gZm5cbiAqIEByZXR1cm5zIHsqfSB0aGUgcmV0dXJuIHZhbHVlIG9mIGZuXG4gKiBAZXhhbXBsZVxuICogdmFyIGhlbHBlciA9IHJlcXVpcmUoJy4vZXhlY3V0ZUNsaWVudFNpZGVTZWxlY3RvcicpO1xuICogLy8gRXhlY3V0ZSBpbiB0aGUgYnJvd3NlclxuICogaGVscGVyKGZuLCBbJ3hwYXRoJywgJy8vYm9keScsICdjc3MnLCAnW2lkPVwid2hhdFwiXSddLCBbMSwgMiwgM10pO1xuICogLy8gQXNzdW1pbmcgZm4gaXMuLi5cbiAqIGZuID0gZnVuY3Rpb24oeHBhdGhSZXN1bHQsIGNzc1Jlc3VsdCwgb25lLCB0d28sIHRocmVlKSB7XG4gKiAgICAgY29uc29sZS5sb2coeHBhdGhSZXN1bHQubGVuZ3RoKTsgLy8gMVxuICogICAgIGNvbnNvbGUubG9nKHhwYXRoUmVzdWx0WzBdKTsgICAgIC8vIDxib2R5Li4uLz5cbiAqICAgICBjb25zb2xlLmxvZyhjc3NSZXN1bHQubGVuZ3RoKTsgICAvLyAwXG4gKiAgICAgY29uc29sZS5sb2cob25lLCB0d28sIHRocmVlKTsgICAgLy8gMSAyIDNcbiAqIH1cbiAqL1xudmFyIGV4ZWN1dGVDbGllbnRTaWRlID0gZnVuY3Rpb24gKGZuLCBzQXJyLCBhcmdzKSB7XG4gICAgdmFyIGNiID0gYXJndW1lbnRzW2FyZ3VtZW50cy5sZW5ndGggLSAxXSxcbiAgICAgICAgaSA9IDAsIHNBcmdzID0gW10sXG4gICAgICAgIHVzZSwgdmFsdWUsIHhwLCBjcywgdG4sXG4gICAgICAgIHJlcywgaiwgYXJnO1xuXG4gICAgaWYgKHR5cGVvZiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsID0gZnVuY3Rpb24oc2VsZWN0b3IpIHtcbiAgICAgICAgICAgIHZhciBkb2MgPSBkb2N1bWVudCxcbiAgICAgICAgICAgICAgICBoZWFkID0gZG9jLmRvY3VtZW50RWxlbWVudC5maXJzdENoaWxkLFxuICAgICAgICAgICAgICAgIHN0eWxlVGFnID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ1NUWUxFJyk7XG4gICAgICAgICAgICBoZWFkLmFwcGVuZENoaWxkKHN0eWxlVGFnKTtcbiAgICAgICAgICAgIGRvYy5fX3FzYWVscyA9IFtdO1xuXG4gICAgICAgICAgICBzdHlsZVRhZy5zdHlsZVNoZWV0LmNzc1RleHQgPSBzZWxlY3RvciArICd7eDpleHByZXNzaW9uKGRvY3VtZW50Ll9fcXNhZWxzLnB1c2godGhpcykpfSc7XG4gICAgICAgICAgICB3aW5kb3cuc2Nyb2xsQnkoMCwgMCk7XG5cbiAgICAgICAgICAgIHJldHVybiBkb2MuX19xc2FlbHM7XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgd2hpbGUgKCh1c2UgPSBzQXJyW2krK10pICYmICh2YWx1ZSA9IHNBcnJbaSsrXSkpIHtcbiAgICAgICAgYXJnID0gW107XG4gICAgICAgIHhwID0gY3MgPSB0biA9IG51bGw7XG4gICAgICAgIHN3aXRjaCAodXNlKSB7XG4gICAgICAgICAgICBjYXNlICdwYXJ0aWFsIGxpbmsgdGV4dCc6XG4gICAgICAgICAgICAgICAgeHAgPSAnLy9hW2NvbnRhaW5zKHRleHQoKSxcIicgKyB2YWx1ZSArICdcIildJztcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ2xpbmsgdGV4dCc6XG4gICAgICAgICAgICAgICAgeHAgPSAnLy9hW3RleHQoKT1cIicgKyB2YWx1ZSArICdcIl0nO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAneHBhdGgnOlxuICAgICAgICAgICAgICAgIHhwID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdpZCc6XG4gICAgICAgICAgICAgICAgY3MgPSAnIycgKyB2YWx1ZTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ25hbWUnOlxuICAgICAgICAgICAgICAgIGNzID0gJ1tuYW1lPVwiJyArIHZhbHVlICsgJ1wiXSc7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICd0YWcgbmFtZSc6XG4gICAgICAgICAgICAgICAgdG4gPSB2YWx1ZTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ2NzcyBzZWxlY3Rvcic6XG4gICAgICAgICAgICAgICAgY3MgPSB2YWx1ZTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGRlZmF1bHQ6IHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IGV2YWx1YXRlIHNlbGVjdG9yOiBJbnZhbGlkIHN0cmF0ZWd5ICcgKyB1c2UpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHhwKSB7XG4gICAgICAgICAgICByZXMgPSBkb2N1bWVudC5ldmFsdWF0ZSh4cCwgZG9jdW1lbnQsIG51bGwsIDAsIG51bGwpO1xuXG4gICAgICAgICAgICB2YWx1ZSA9IHJlcy5pdGVyYXRlTmV4dCgpO1xuICAgICAgICAgICAgd2hpbGUgKHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgYXJnLnB1c2godmFsdWUpO1xuICAgICAgICAgICAgICAgIHZhbHVlID0gcmVzLml0ZXJhdGVOZXh0KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAodG4gfHwgY3MpIHtcbiAgICAgICAgICAgIHJlcyA9IHRuID8gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUodG4pIDogZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChjcyk7XG4gICAgICAgICAgICBmb3IoaiA9IDA7IGogPCByZXMubGVuZ3RoOyArK2opIHtcbiAgICAgICAgICAgICAgICBhcmcucHVzaChyZXNbal0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHNBcmdzLnB1c2goYXJnKTtcbiAgICB9XG5cbiAgICB2YXIgcGFyYW1ldGVyID0gYXJncyAmJiBzQXJncy5jb25jYXQoYXJncykgfHwgc0FyZ3M7XG4gICAgaWYocGFyYW1ldGVyLmxlbmd0aCA9PT0gMCB8fCAocGFyYW1ldGVyLmxlbmd0aCA9PT0gMSAmJiBwYXJhbWV0ZXJbMF0ubGVuZ3RoID09PSAwKSkge1xuICAgICAgICBpZih0eXBlb2YgY2IgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIHJldHVybiBjYignTm9TdWNoRWxlbWVudCcpICYmIG5ldyBFcnJvcignTm9TdWNoRWxlbWVudCcpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBuZXcgRXJyb3IoJ05vU3VjaEVsZW1lbnQnKTtcbiAgICB9XG5cbiAgICBwYXJhbWV0ZXIucHVzaChhcmd1bWVudHNbYXJndW1lbnRzLmxlbmd0aCAtIDFdKTtcblxuICAgIHJldHVybiBmbi5hcHBseSh3aW5kb3csIHBhcmFtZXRlcik7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjcmVhdGVTZWxlY3RvclNjcmlwdFxuIl19
